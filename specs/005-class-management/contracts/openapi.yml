openapi: 3.0.3
info:
  title: Class Management API
  description: |
    Class management endpoints within student-service for teachers to manage academic classes.

    **Feature**: 005-class-management
    **Service**: student-service (extension)
    **Base Path**: /api/classes
    **Authentication**: JWT Bearer token required for all endpoints
    **Response Format**: All responses wrapped in ApiResponse<T> format

    ## Key Features
    - List teacher's classes with Redis caching (30min TTL)
    - View class details with student roster (15min cache TTL)
    - View enrollment history (60min cache TTL, read-only)
    - Create, update, and archive classes
    - Teacher authorization enforcement

    ## Grade Levels
    Cambodia education system: GRADE_1 to GRADE_12
    - Primary: Grades 1-6
    - Lower Secondary: Grades 7-9
    - Upper Secondary: Grades 10-12

    ## Academic Year Format
    Format: "YYYY-YYYY" (e.g., "2024-2025")
    Validation: Second year must equal first year + 1

    **Note**: Schedule data is NOT included - will be handled by separate future service (per clarification #3).
  version: 1.0.0
  contact:
    name: SMS Development Team
    email: dev@salarean.edu.kh

servers:
  - url: http://localhost:8080/api
    description: API Gateway (local development)
  - url: https://api.salarean.edu.kh/api
    description: Production API Gateway

tags:
  - name: Classes
    description: Class management operations
  - name: Enrollment
    description: Student roster and enrollment history

security:
  - BearerAuth: []

paths:
  /classes:
    get:
      tags:
        - Classes
      summary: List teacher's classes
      description: |
        Retrieve a list of all classes for the authenticated teacher.
        By default, returns only active (non-archived) classes.

        **Caching**: Results cached for 30 minutes.

        **Authorization**: Teachers see only their own classes.
      operationId: listClasses
      parameters:
        - name: includeArchived
          in: query
          description: Include archived classes in the response
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassListResponse'
              examples:
                success:
                  summary: Teacher with 3 active classes
                  value:
                    errorCode: SUCCESS
                    data:
                      - id: 550e8400-e29b-41d4-a716-446655440001
                        name: Mathematics Grade 10A
                        gradeLevel: GRADE_10
                        subject: Mathematics
                        academicYear: 2024-2025
                        capacity: 40
                        currentEnrollment: 35
                        teacherId: 660e8400-e29b-41d4-a716-446655440002
                        archived: false
                        createdAt: 2024-09-01T00:00:00Z
                      - id: 550e8400-e29b-41d4-a716-446655440003
                        name: Physics Grade 11B
                        gradeLevel: GRADE_11
                        subject: Physics
                        academicYear: 2024-2025
                        capacity: 35
                        currentEnrollment: 32
                        teacherId: 660e8400-e29b-41d4-a716-446655440002
                        archived: false
                        createdAt: 2024-09-01T00:00:00Z
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Classes
      summary: Create a new class
      description: |
        Create a new academic class. Requires appropriate permissions.

        **Authorization**: Administrators and authorized teachers only.

        **Validation**: Prevents duplicate classes (same name, grade, subject, year).

        **Cache Invalidation**: Invalidates teacher's class list cache.
      operationId: createClass
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClassCreateRequest'
            examples:
              valid:
                summary: Create Mathematics class
                value:
                  name: Mathematics Grade 10A
                  gradeLevel: GRADE_10
                  subject: Mathematics
                  academicYear: 2024-2025
                  capacity: 40
                  description: Advanced mathematics for Grade 10 students
      responses:
        '200':
          description: Class created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassDetailResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /classes/{id}:
    get:
      tags:
        - Classes
      summary: Get class details
      description: |
        Retrieve detailed information about a specific class.

        **Caching**: Results cached for 15 minutes (without student roster).

        **Authorization**: Teachers can only access their own classes.
      operationId: getClassDetails
      parameters:
        - $ref: '#/components/parameters/ClassId'
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassDetailResponse'
              examples:
                success:
                  summary: Class details without students
                  value:
                    errorCode: SUCCESS
                    data:
                      id: 550e8400-e29b-41d4-a716-446655440001
                      name: Mathematics Grade 10A
                      gradeLevel: GRADE_10
                      subject: Mathematics
                      academicYear: 2024-2025
                      capacity: 40
                      currentEnrollment: 35
                      teacherId: 660e8400-e29b-41d4-a716-446655440002
                      description: Advanced mathematics for Grade 10 students
                      archived: false
                      createdAt: 2024-09-01T00:00:00Z
                      updatedAt: 2024-09-01T00:00:00Z
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Classes
      summary: Update class information
      description: |
        Update an existing class's information. Partial updates supported.

        **Authorization**: Teachers can only update their own classes.
        Administrators can update any class.

        **Cache Invalidation**: Invalidates both class list and class details caches.

        **Optimistic Locking**: Uses version field to prevent lost updates.
      operationId: updateClass
      parameters:
        - $ref: '#/components/parameters/ClassId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClassUpdateRequest'
            examples:
              updateCapacity:
                summary: Update class capacity
                value:
                  capacity: 45
                  description: Expanded capacity for high enrollment
      responses:
        '200':
          description: Class updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassDetailResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Classes
      summary: Archive class
      description: |
        Archive a class (soft delete). Archived classes are hidden from default
        class lists but remain accessible for historical reference.

        **Behavior**: Students remain enrolled in archived class (per FR-027 clarification).

        **Authorization**: Administrators and authorized teachers only.

        **Cache Invalidation**: Invalidates teacher's class list cache.

        **Note**: This is NOT a hard delete. Use DELETE for semantic consistency
        with REST conventions, but operation performs soft delete (sets archived=true).
      operationId: archiveClass
      parameters:
        - $ref: '#/components/parameters/ClassId'
      responses:
        '200':
          description: Class archived successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
              examples:
                success:
                  value:
                    errorCode: SUCCESS
                    data: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /classes/{id}/students:
    get:
      tags:
        - Enrollment
      summary: Get current class students
      description: |
        Retrieve the current student roster for a specific class.

        **Integration**: Fetches student details from student-service.

        **Caching**: Results cached for 15 minutes.

        **Authorization**: Teachers can only access their own classes' rosters.

        **Failure Handling**: If student-service is unavailable, returns error indicator
        but does not fail the entire request.
      operationId: getClassStudents
      parameters:
        - $ref: '#/components/parameters/ClassId'
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StudentRosterResponse'
              examples:
                success:
                  summary: Class with 3 enrolled students
                  value:
                    errorCode: SUCCESS
                    data:
                      - studentId: 770e8400-e29b-41d4-a716-446655440010
                        studentIdNumber: STU001
                        firstNameLatin: Sophea
                        lastNameLatin: Chan
                        gradeLevel: GRADE_10
                        enrollmentDate: 2024-09-01T00:00:00Z
                        status: ACTIVE
                      - studentId: 770e8400-e29b-41d4-a716-446655440011
                        studentIdNumber: STU002
                        firstNameLatin: Dara
                        lastNameLatin: Pov
                        gradeLevel: GRADE_10
                        enrollmentDate: 2024-09-01T00:00:00Z
                        status: ACTIVE
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /classes/{id}/history:
    get:
      tags:
        - Enrollment
      summary: Get class enrollment history
      description: |
        Retrieve the complete enrollment history for a class, including all
        enrollment, transfer, and withdrawal events.

        **Sorting**: Events returned in descending chronological order (newest first).

        **Caching**: Results cached for 60 minutes (historical data changes infrequently).

        **Authorization**: Teachers can only access their own classes' history.

        **Compliance**: Maintains audit trail for MoEYS record-keeping requirements.
      operationId: getEnrollmentHistory
      parameters:
        - $ref: '#/components/parameters/ClassId'
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrollmentHistoryResponse'
              examples:
                success:
                  summary: Enrollment history with mixed events
                  value:
                    errorCode: SUCCESS
                    data:
                      - id: 880e8400-e29b-41d4-a716-446655440020
                        classId: 550e8400-e29b-41d4-a716-446655440001
                        studentId: 770e8400-e29b-41d4-a716-446655440010
                        eventType: ENROLLED
                        eventTimestamp: 2024-09-01T00:00:00Z
                        performedBy: 660e8400-e29b-41d4-a716-446655440002
                        notes: Initial enrollment
                      - id: 880e8400-e29b-41d4-a716-446655440021
                        classId: 550e8400-e29b-41d4-a716-446655440001
                        studentId: 770e8400-e29b-41d4-a716-446655440012
                        eventType: TRANSFERRED_IN
                        eventTimestamp: 2024-09-15T00:00:00Z
                        sourceClassId: 550e8400-e29b-41d4-a716-446655440099
                        performedBy: 660e8400-e29b-41d4-a716-446655440002
                        notes: Transferred from Class 10B
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from auth-service

  parameters:
    ClassId:
      name: id
      in: path
      description: Class UUID
      required: true
      schema:
        type: string
        format: uuid
      example: 550e8400-e29b-41d4-a716-446655440001

  schemas:
    # ========== API Response Wrappers ==========
    ApiResponseVoid:
      type: object
      required:
        - errorCode
        - data
      properties:
        errorCode:
          type: string
          enum:
            - SUCCESS
            - CLASS_NOT_FOUND
            - UNAUTHORIZED_CLASS_ACCESS
            - DUPLICATE_CLASS_NAME
            - INVALID_CLASS_DATA
            - INVALID_ACADEMIC_YEAR_FORMAT
            - VALIDATION_FAILED
            - CONCURRENT_UPDATE_CONFLICT
            - INTERNAL_SERVER_ERROR
          description: Machine-readable error code for i18n translation
        data:
          type: object
          nullable: true
          description: Response payload (null for void operations)

    ClassListResponse:
      type: object
      required:
        - errorCode
        - data
      properties:
        errorCode:
          type: string
          enum: [SUCCESS]
        data:
          type: array
          items:
            $ref: '#/components/schemas/ClassSummaryDto'

    ClassDetailResponse:
      type: object
      required:
        - errorCode
        - data
      properties:
        errorCode:
          type: string
          enum: [SUCCESS]
        data:
          $ref: '#/components/schemas/ClassDetailDto'

    StudentRosterResponse:
      type: object
      required:
        - errorCode
        - data
      properties:
        errorCode:
          type: string
          enum: [SUCCESS]
        data:
          type: array
          items:
            $ref: '#/components/schemas/StudentRosterItemDto'

    EnrollmentHistoryResponse:
      type: object
      required:
        - errorCode
        - data
      properties:
        errorCode:
          type: string
          enum: [SUCCESS]
        data:
          type: array
          items:
            $ref: '#/components/schemas/EnrollmentHistoryDto'

    ErrorResponse:
      type: object
      required:
        - errorCode
        - data
      properties:
        errorCode:
          type: string
          description: Machine-readable error code
        data:
          type: object
          nullable: true

    # ========== DTOs ==========
    ClassSummaryDto:
      type: object
      required:
        - id
        - name
        - gradeLevel
        - subject
        - academicYear
        - capacity
        - teacherId
        - archived
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Class unique identifier
        name:
          type: string
          minLength: 3
          maxLength: 100
          description: Class display name
        gradeLevel:
          $ref: '#/components/schemas/GradeLevel'
        subject:
          type: string
          maxLength: 50
          description: Subject name
        academicYear:
          type: string
          maxLength: 20
          pattern: '^\d{4}-\d{4}$'
          description: Academic year (format YYYY-YYYY)
          example: 2024-2025
        capacity:
          type: integer
          minimum: 5
          maximum: 60
          description: Maximum number of students
        currentEnrollment:
          type: integer
          minimum: 0
          description: Number of currently enrolled students
        teacherId:
          type: string
          format: uuid
          description: Assigned teacher UUID
        archived:
          type: boolean
          description: Whether class is archived
        createdAt:
          type: string
          format: date-time
          description: Class creation timestamp (ISO 8601 UTC)

    ClassDetailDto:
      allOf:
        - $ref: '#/components/schemas/ClassSummaryDto'
        - type: object
          properties:
            description:
              type: string
              maxLength: 500
              nullable: true
              description: Optional class description
            updatedAt:
              type: string
              format: date-time
              description: Last update timestamp (ISO 8601 UTC)

    ClassCreateRequest:
      type: object
      required:
        - name
        - gradeLevel
        - subject
        - academicYear
        - capacity
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 100
          description: Class display name
        gradeLevel:
          $ref: '#/components/schemas/GradeLevel'
        subject:
          type: string
          maxLength: 50
          description: Subject name
        academicYear:
          type: string
          maxLength: 20
          pattern: '^\d{4}-\d{4}$'
          description: Academic year (format YYYY-YYYY)
          example: 2024-2025
        capacity:
          type: integer
          minimum: 5
          maximum: 60
          description: Maximum number of students
        description:
          type: string
          maxLength: 500
          nullable: true
          description: Optional class description

    ClassUpdateRequest:
      type: object
      description: Partial update - all fields optional
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 100
        capacity:
          type: integer
          minimum: 5
          maximum: 60
        description:
          type: string
          maxLength: 500
          nullable: true

    StudentRosterItemDto:
      type: object
      description: Student details fetched from student-service
      required:
        - studentId
        - studentIdNumber
        - firstNameLatin
        - lastNameLatin
        - gradeLevel
        - enrollmentDate
        - status
      properties:
        studentId:
          type: string
          format: uuid
          description: Student UUID (from student-service)
        studentIdNumber:
          type: string
          description: Human-readable student ID
          example: STU001
        firstNameLatin:
          type: string
          description: Student first name (Latin characters)
        lastNameLatin:
          type: string
          description: Student last name (Latin characters)
        gradeLevel:
          $ref: '#/components/schemas/GradeLevel'
        enrollmentDate:
          type: string
          format: date-time
          description: Date student enrolled in this class
        status:
          type: string
          enum:
            - ACTIVE
            - INACTIVE
            - TRANSFERRED
          description: Student enrollment status

    EnrollmentHistoryDto:
      type: object
      required:
        - id
        - classId
        - studentId
        - eventType
        - eventTimestamp
        - performedBy
      properties:
        id:
          type: string
          format: uuid
          description: Event record UUID
        classId:
          type: string
          format: uuid
          description: Class where event occurred
        studentId:
          type: string
          format: uuid
          description: Student affected by event
        eventType:
          $ref: '#/components/schemas/EnrollmentEventType'
        eventTimestamp:
          type: string
          format: date-time
          description: When event occurred (ISO 8601 UTC)
        sourceClassId:
          type: string
          format: uuid
          nullable: true
          description: Origin class for TRANSFERRED_IN events
        destinationClassId:
          type: string
          format: uuid
          nullable: true
          description: Target class for TRANSFERRED_OUT events
        performedBy:
          type: string
          format: uuid
          description: Teacher/admin who performed the action
        notes:
          type: string
          maxLength: 500
          nullable: true
          description: Optional notes/reason

    # ========== Enums ==========
    GradeLevel:
      type: string
      enum:
        - GRADE_1
        - GRADE_2
        - GRADE_3
        - GRADE_4
        - GRADE_5
        - GRADE_6
        - GRADE_7
        - GRADE_8
        - GRADE_9
        - GRADE_10
        - GRADE_11
        - GRADE_12
      description: Cambodia education system grade levels

    EnrollmentEventType:
      type: string
      enum:
        - ENROLLED
        - TRANSFERRED_OUT
        - WITHDRAWN
        - TRANSFERRED_IN
      description: Type of enrollment event

  responses:
    BadRequest:
      description: Validation error or duplicate class
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            validationError:
              summary: Validation failed
              value:
                errorCode: VALIDATION_FAILED
                data: null
            duplicateClass:
              summary: Duplicate class name
              value:
                errorCode: DUPLICATE_CLASS_NAME
                data: null
            invalidAcademicYear:
              summary: Invalid academic year format
              value:
                errorCode: INVALID_ACADEMIC_YEAR_FORMAT
                data: null

    Unauthorized:
      description: Invalid or missing JWT token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: UNAUTHORIZED
            data: null

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: UNAUTHORIZED_CLASS_ACCESS
            data: null

    NotFound:
      description: Class not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: CLASS_NOT_FOUND
            data: null

    Conflict:
      description: Optimistic locking conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: CONCURRENT_UPDATE_CONFLICT
            data: null

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: INTERNAL_SERVER_ERROR
            data: null
